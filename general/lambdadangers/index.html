<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
    










    







<script defer language="javascript" type="text/javascript" src="/js/bundle.min.145453261a7755f5042a854c4213501d215a8fbe34c08d181c40f803f1315e74.js"></script>





  



    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" href=/favicon.png>

    
    





  





  
  
  


<!-- Open Graph image and Twitter Card metadata -->

<title itemprop="name">Dr. Elliot - The dangers of Lambdas</title>
<meta property="og:title" content=Dr.&#32;Elliot&#32;-&#32;The&#32;dangers&#32;of&#32;Lambdas />
<meta name="twitter:title" content=Dr.&#32;Elliot&#32;-&#32;The&#32;dangers&#32;of&#32;Lambdas />
<meta itemprop="name" content=Dr.&#32;Elliot&#32;-&#32;The&#32;dangers&#32;of&#32;Lambdas />
<meta name="application-name" content=Dr.&#32;Elliot&#32;-&#32;The&#32;dangers&#32;of&#32;Lambdas />
<meta property="og:site_name" content="Dr. Elliot" />


<meta name="description" content="" />
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />


<base href="https://mrdrelliot.github.io/general/lambdadangers/" />
<link rel="canonical" href="https://mrdrelliot.github.io/general/lambdadangers/" itemprop="url" />
<meta name="url" content="https://mrdrelliot.github.io/general/lambdadangers/" />
<meta name="twitter:url" content="https://mrdrelliot.github.io/general/lambdadangers/" />
<meta property="og:url" content="https://mrdrelliot.github.io/general/lambdadangers/" />


<meta property="og:updated_time" content="2024-08-16T13:46:48-05:00" />


<link rel="sitemap" type="application/xml" title="Sitemap" href='https://mrdrelliot.github.io/sitemap.xml' />

<meta name="robots" content="index,follow" />
<meta name="googlebot" content="index,follow" />



<meta property="fb:admins" content="" />


<meta name="apple-mobile-web-app-title" content="Dr. Elliot" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />






<meta name="generator" content="Hugo 0.132.2">


    
    

<link type="text/css" rel="stylesheet" href="/css/bundle.min.94a339836f89f0d25f31980cb6b0631da21e20af128308747ce44e0525eb16ef.css">


    
    <style>
    body {
        --sidebar-bg-color: #202020;
        --sidebar-img-border-color: #515151;
        --sidebar-p-color: #909090;
        --sidebar-h1-color: #FFF;
        --sidebar-a-color: #FFF;
        --sidebar-socials-color: #FFF;
        --text-color: #222;
        --bkg-color: #FAF9F6;
        --post-title-color: #303030;
        --list-color: #5A5A5A;
        --link-color: #268BD2;
        --date-color: #515151;
        --table-border-color: #E5E5E5;
        --table-stripe-color: #F9F9F9;
        --code-color: #000;
        --code-background-color: #E5E5E5;
        --code-block-color: #FFF;
        --code-block-background-color: #272822;
        --moon-sun-color: #FFF;
        --moon-sun-background-color: #515151;
    }
    body.dark-theme {
        --text-color: #EEE;
        --bkg-color: #121212;
        --post-title-color: #DBE2E9;
        --list-color: #9D9D9D;
        --link-color: #268BD2;
        --date-color: #9A9A9A;
        --table-border-color: #515151;
        --table-stripe-color: #202020;
        --code-color: #FFF;
        --code-background-color: #515151;
        --code-block-color: #FFF;
        --code-block-background-color: #272822;
    }
    body {
        background-color: var(--bkg-color);
    }
</style>

</head>

    <body class="dark-theme">
        <div class="wrapper">
            <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark" title="Toggle light/dark mode">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
        
            <a href="https://mrdrelliot.github.io/">
                <h1>Dr. Elliot</h1>
            </a>
        
    </h1>
    <p class="lead">
    A collection of things I've learned using Unreal Engine.
    </p>
</div>

        <nav>
    <ul class="sidebar-nav">

        
        
        
        
            

            
                
                
                    <li class="heading">
                        <a href="/about/">About</a>
                    </li>
                    
                
            
                
                
            
                
                
            
                
                
            
                
                
            
            
                
                
            
                
                
            
        
        
            

            
                
                
            
                
                
            
                
                
                    <li class="heading">
                        <a href="/general/">General</a>
                    </li>
                    
                        <li class="sub-heading">
                            
                        </li>
                        
                            <li class="bullet">
                                <a href="https://mrdrelliot.github.io/general/bpvscpp/">Blueprint vs C&#43;&#43;: Different Tools for Different Jobs</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://mrdrelliot.github.io/general/inheritenceoveruse/">Overuse of Inheritence, alternatives.</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://mrdrelliot.github.io/general/lambdadangers/">The dangers of Lambdas</a>
                            </li>
                        
                    
                
            
                
                
            
                
                
            
            
                
                
            
                
                
            
        
        
            

            
                
                
            
                
                
            
                
                
            
                
                
            
                
                
                    <li class="heading">
                        <a href="/networking/">Networking</a>
                    </li>
                    
                        <li class="sub-heading">
                            
                        </li>
                        
                            <li class="bullet">
                                <a href="https://mrdrelliot.github.io/networking/networkserialization/">Network Serialization</a>
                            </li>
                        
                    
                
            
            
                
                
            
                
                
            
        
        
            

            
                
                
            
                
                
            
                
                
            
                
                
                    <li class="heading">
                        <a href="/memory/">Memory</a>
                    </li>
                    
                        <li class="sub-heading">
                            
                        </li>
                        
                            <li class="bullet">
                                <a href="https://mrdrelliot.github.io/memory/tarrayallocators/">TArray Allocators</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://mrdrelliot.github.io/memory/templateobjecttypes/">Templated Object Types</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://mrdrelliot.github.io/memory/softreferences/">What Are Soft References?</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://mrdrelliot.github.io/memory/buffers/">Working With Buffers</a>
                            </li>
                        
                    
                
            
                
                
            
            
                
                
            
                
                
            
        
        
            

            
                
                
            
                
                
                    <li class="heading">
                        <a href="/gas/">Gameplay Ability System</a>
                    </li>
                    
                        <li class="sub-heading">
                            
                        </li>
                        
                            <li class="bullet">
                                <a href="https://mrdrelliot.github.io/gas/intro/">Intro</a>
                            </li>
                        
                    
                
            
                
                
            
                
                
            
                
                
            
            
                
                
            
                
                
            
        

    </ul>
</nav>

        








    <a target="_blank" class="social" title="Discord" href="https://discord.gg/WTqSFrBg6t">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 24 24">
            <path fill="currentColor" d="M19.27 5.33C17.94 4.71 16.5 4.26 15 4a.09.09 0 0 0-.07.03c-.18.33-.39.76-.53 1.09a16.09 16.09 0 0 0-4.8 0c-.14-.34-.35-.76-.54-1.09c-.01-.02-.04-.03-.07-.03c-1.5.26-2.93.71-4.27 1.33c-.01 0-.02.01-.03.02c-2.72 4.07-3.47 8.03-3.1 11.95c0 .02.01.04.03.05c1.8 1.32 3.53 2.12 5.24 2.65c.03.01.06 0 .07-.02c.4-.55.76-1.13 1.07-1.74c.02-.04 0-.08-.04-.09c-.57-.22-1.11-.48-1.64-.78c-.04-.02-.04-.08-.01-.11c.11-.08.22-.17.33-.25c.02-.02.05-.02.07-.01c3.44 1.57 7.15 1.57 10.55 0c.02-.01.05-.01.07.01c.11.09.22.17.33.26c.04.03.04.09-.01.11c-.52.31-1.07.56-1.64.78c-.04.01-.05.06-.04.09c.32.61.68 1.19 1.07 1.74c.03.01.06.02.09.01c1.72-.53 3.45-1.33 5.25-2.65c.02-.01.03-.03.03-.05c.44-4.53-.73-8.46-3.1-11.95c-.01-.01-.02-.02-.04-.02zM8.52 14.91c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.84 2.12-1.89 2.12zm6.97 0c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.83 2.12-1.89 2.12z"/>
        </svg>
    </a>













        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | themed with <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
    &copy; 2024 Dr. Elliot. All rights reserved.
</p>

  </div>
</aside>

            <main class="content container">
                <div class="post">
  <div class="info">
  <h1 class="post-title">
    <a href="https://mrdrelliot.github.io/general/lambdadangers/">The dangers of Lambdas</a>
  </h1>

  <div class="headline">
    <div>
      
      
      <time datetime=" 2024-08-16T13:46:48-0500" class="post-date">
        August 16, 2024
      </time>
      
      <span> - </span>
      <span class="reading-time">
        
          
        

        <span>3 mins read</span>
      </span>
    </div>

    
  </div>

  
  

  
</div>

  <h1 id="using-lambdas-in-unreal-can-be-dangerous">Using Lambdas in Unreal can be dangerous!</h1>
<hr>
<p>Lambdas, or anonymous functions, in Unreal Engine can be very useful for writing concise and flexible code. However, they come with certain dangers, particularly when dealing with the lifetime of objects and capturing variables by reference. Here’s why:</p>
<h3 id="1-capturing-by-reference-and-object-lifetimes">1. <strong>Capturing by Reference and Object Lifetimes</strong></h3>
<p>When you use lambdas in Unreal Engine, you might capture variables by reference, which is common for avoiding unnecessary copying. However, if the lambda is executed asynchronously (e.g., in a timer, or a delegate callback), the objects referenced might be destroyed or go out of scope by the time the lambda is executed. This leads to dereferencing invalid memory, causing crashes with errors like:</p>
<pre tabindex="0"><code>Unhandled Exception: EXCEPTION_ACCESS_VIOLATION reading address 0x0000000000000000
</code></pre><p>This particular error occurs because the lambda is trying to access an object or memory location that no longer exists, often leading to a null pointer dereference.</p>
<h3 id="2-deferred-execution">2. <strong>Deferred Execution</strong></h3>
<p>In Unreal, many systems use deferred execution, where code is scheduled to run later (e.g., after a delay, or on the next frame). Lambdas are often used in these scenarios for their flexibility. However, if the lambda captures pointers or references to Unreal objects that may be garbage collected or destroyed before the lambda runs, the lambda will end up accessing invalid memory. This is especially problematic in cases where the object’s destruction isn’t under your control, such as when the object is managed by Unreal’s garbage collector.</p>
<h3 id="3-complex-debugging">3. <strong>Complex Debugging</strong></h3>
<p>Lambdas can obscure the flow of your code, making debugging more complex. When a crash happens inside a lambda, the stack trace might not clearly indicate where or why it occurred. This is because the lambda could be executed in a completely different context from where it was defined, making it difficult to track down the source of the problem.</p>
<h3 id="4-capturing-this">4. <strong>Capturing <code>this</code></strong></h3>
<p>Another common pitfall is capturing <code>this</code> inside a lambda. If the lambda is executed after the object has been destroyed, it will try to access a member function or variable of an object that no longer exists, leading to undefined behavior. This is particularly dangerous in Unreal, where object lifetimes are managed in complex ways, especially with asynchronous tasks.</p>
<h3 id="how-to-mitigate-these-issues"><strong>How to Mitigate These Issues</strong></h3>
<ol>
<li>
<p><strong>Prefer Capturing by Value:</strong> If possible, capture variables by value rather than by reference. This way, the lambda will have its own copy of the data, independent of the original object&rsquo;s lifetime.</p>
</li>
<li>
<p><strong>Use <code>TWeakObjectPtr</code>:</strong> When capturing pointers to Unreal objects, consider using <code>TWeakObjectPtr</code> instead of raw pointers. <code>TWeakObjectPtr</code> will safely handle cases where the object is destroyed, allowing you to check if the object is still valid before accessing it.</p>
</li>
<li>
<p><strong>Check for Validity:</strong> Before accessing any captured pointers or references, explicitly check their validity within the lambda. This includes checking if pointers are <code>nullptr</code> or if <code>TWeakObjectPtr</code> is still valid.</p>
</li>
<li>
<p><strong>Keep Lambdas Small and Focused:</strong> Try to keep lambdas small and focused on a single task. This makes it easier to track down issues and reduces the likelihood of capturing unnecessary variables.</p>
</li>
<li>
<p><strong>Using a <code>Weak Lambda</code>.</strong> Some may consider this a hack, but a <em>weak lambda</em> allows you to safely reference an object inside of a lambda, and avoid calling the lambda through the delegate if the owning object is invalid.
&ndash; Here is a quick example of a weak lambda in use. Taken from <code>TestBTTask_TimerBasedLatent.cpp</code></p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">const</span> UWorld<span style="color:#f92672">*</span> World <span style="color:#f92672">=</span> OwnerComp.GetWorld())
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">float</span> DeltaTime <span style="color:#f92672">=</span> NumTicksExecuting <span style="color:#f92672">*</span> FAITestHelpers<span style="color:#f92672">::</span>TickInterval;
</span></span><span style="display:flex;"><span>		World<span style="color:#f92672">-&gt;</span>GetTimerManager().SetTimer(TaskMemory<span style="color:#f92672">-&gt;</span>TimerHandle,
</span></span><span style="display:flex;"><span>			FTimerDelegate<span style="color:#f92672">::</span>CreateWeakLambda(<span style="color:#66d9ef">this</span>, [<span style="color:#f92672">&amp;</span>OwnerComp, TaskMemory, <span style="color:#66d9ef">this</span>]() <span style="color:#75715e">// &lt;---- This is the declaration of a weak lambda
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			{
</span></span><span style="display:flex;"><span>				TaskMemory<span style="color:#f92672">-&gt;</span>TimerHandle.Invalidate();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				ensure(<span style="color:#f92672">!</span>TaskMemory<span style="color:#f92672">-&gt;</span>bIsAborting);
</span></span><span style="display:flex;"><span>				LogExecution(OwnerComp, LogIndexExecuteFinish);
</span></span><span style="display:flex;"><span>				FinishLatentTask(OwnerComp, LogResult);
</span></span><span style="display:flex;"><span>			}), DeltaTime, false);
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><p>By being aware of these potential dangers and taking appropriate precautions, you can safely use lambdas in Unreal Engine without running into unexpected crashes or undefined behavior.</p>

  
  <hr>
<div class="footer">
    
	    
	    
            <div class="next-post">
                <a href="https://mrdrelliot.github.io/general/inheritenceoveruse/?ref=footer"><span style="font-weight:bold;">Next »</span><br>Overuse of Inheritence, alternatives.</a>
            </div>
        
    
</div>

  
</div>
            </main>
            
  
    <div class="article-toc ">
    <div class="toc-wrapper">
      <h4 id="contents"></h4>
      <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-capturing-by-reference-and-object-lifetimes">1. <strong>Capturing by Reference and Object Lifetimes</strong></a></li>
        <li><a href="#2-deferred-execution">2. <strong>Deferred Execution</strong></a></li>
        <li><a href="#3-complex-debugging">3. <strong>Complex Debugging</strong></a></li>
        <li><a href="#4-capturing-this">4. <strong>Capturing <code>this</code></strong></a></li>
        <li><a href="#how-to-mitigate-these-issues"><strong>How to Mitigate These Issues</strong></a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

  

        </div>
    </body>
</html>
